<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduGenie AI Tutor</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <!-- Tailwind & Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <!-- THREE must load BEFORE VANTA -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <style>
    html, body { height: 100%; }
    body {
      min-height: 100dvh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      overflow: hidden; /* keep to avoid page growing */
      background-color: #f9fafb;
    }
    .page { min-height: 0; overflow: hidden; }
    .card { display: flex; flex-direction: column; height: 100%; min-height: 0; }
    .chat-container { flex: 1 1 auto; min-height: 0; overflow: auto; }
    #vanta-bg { position: fixed; inset: 0; z-index: -1; opacity: 0.15; }
    .msg p { white-space: pre-wrap; }
    .btn { transition: transform .05s ease; }
    .btn:active { transform: translateY(1px) scale(0.99); }
    .badge { font-size: .7rem; }
    details summary { cursor:pointer; }
  </style>
</head>
<body class="font-sans antialiased">
  <div id="vanta-bg"></div>
  <header class="text-center p-4">
    <h1 class="text-4xl font-bold text-gray-800">EduGenie AI Tutor</h1>
    <p class="text-gray-600">Your math & data‑science tutor — adaptive, step‑by‑step explanations</p>
  </header>

  <main class="page container mx-auto px-4">
    <div class="bg-white rounded-xl shadow-xl overflow-hidden max-w-3xl mx-auto card">
      <!-- Top controls -->
      <div class="bg-gradient-to-r from-indigo-500 to-green-500 p-3 flex items-center justify-between flex-wrap gap-2">
        <div class="flex items-center gap-2">
          <span class="text-white/90 text-sm">Difficulty:</span>
          <button class="difficulty-btn bg-white text-indigo-600 px-3 py-1 rounded-full btn" data-level="beginner">Beginner</button>
          <button class="difficulty-btn bg-white text-indigo-600 px-3 py-1 rounded-full btn" data-level="intermediate">Intermediate</button>
          <button class="difficulty-btn bg-white text-indigo-600 px-3 py-1 rounded-full btn" data-level="advanced">Advanced</button>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-white/90 text-sm">Mode:</span>
          <button id="mode-chat" class="mode-btn bg-white text-indigo-600 px-3 py-1 rounded-full btn" data-mode="chat">Chat</button>
          <button id="mode-quiz" class="mode-btn bg-white text-indigo-600 px-3 py-1 rounded-full btn" data-mode="quiz">Quiz</button>
        </div>
      </div>

      <!-- Messages -->
      <div class="chat-container p-4 space-y-3" id="chat-messages">
        <div class="flex items-start gap-2">
          <div class="bg-indigo-100 p-3 rounded-full"><i data-feather="cpu" class="text-indigo-500"></i></div>
          <div class="bg-gray-100 rounded-lg p-3 msg">
            <p class="text-gray-800">Hi! I'm EduGenie. Ask me any math or data‑science question. I will give a <strong>step‑by‑step solution</strong> and adapt my explanation to your selected difficulty. Switch to <span class="font-semibold">Quiz</span> to generate practice questions with auto‑checking.</p>
          </div>
        </div>
      </div>

      <!-- Composer / Quiz toolbar -->
      <div id="toolbar-chat" class="border-t p-3 bg-gray-50 flex items-center gap-2">
        <input id="user-input" class="flex-1 border rounded-full px-3 py-2" placeholder="Ask a question… e.g., ‘Solve ∫ x e^{x} dx’ or ‘Explain gradient descent’" />
        <button id="send-btn" class="bg-indigo-500 text-white rounded-full p-2 hover:bg-indigo-600 btn" title="Send"><i data-feather="send"></i></button>
        <button id="clear-btn" class="bg-gray-300 text-gray-700 rounded-full p-2 hover:bg-gray-400 btn" title="Clear history"><i data-feather="trash-2"></i></button>
      </div>

      <div id="toolbar-quiz" class="border-t p-3 bg-gray-50 hidden">
        <div class="flex flex-col gap-2 w-full">
          <div class="flex items-center gap-2">
            <input id="quiz-topic" class="flex-1 border rounded-full px-3 py-2" placeholder="Quiz topic… e.g., Linear regression, Limits, Probability" />
            <input id="quiz-count" type="number" min="1" max="10" value="5" class="w-24 border rounded-full px-3 py-2" />
            <button id="quiz-generate" class="bg-emerald-500 text-white rounded-full px-4 py-2 hover:bg-emerald-600 btn"><i data-feather="help-circle" class="mr-1"></i>Generate Quiz</button>
            <button id="quiz-clear" class="bg-gray-300 text-gray-700 rounded-full px-4 py-2 hover:bg-gray-400 btn"><i data-feather="trash-2" class="mr-1"></i>Clear</button>
          </div>
          <p class="text-xs text-gray-500 ml-1">Auto‑checking: numeric answers are compared within a small tolerance; text answers are compared case‑insensitively and by keywords.</p>
        </div>
      </div>
    </div>
  </main>

  <footer class="text-center py-2 text-gray-500 text-sm">© 2025 EduGenie</footer>

<script>
  feather.replace();

  // ======= State =======
  let currentLevel = 'intermediate';
  let currentMode = 'chat'; // 'chat' | 'quiz'
  const chat = document.getElementById('chat-messages');
  const input = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');
  const clearBtn = document.getElementById('clear-btn');
  const toolbarChat = document.getElementById('toolbar-chat');
  const toolbarQuiz = document.getElementById('toolbar-quiz');

  // Quiz elements
  const quizTopic = document.getElementById('quiz-topic');
  const quizCount = document.getElementById('quiz-count');
  const quizGenerate = document.getElementById('quiz-generate');
  const quizClear = document.getElementById('quiz-clear');

  // Set default active styles on load
  function setInitialButtons(){
    document.querySelectorAll('.difficulty-btn').forEach(b=>{
      b.classList.remove('bg-indigo-500','text-white');
      if(b.dataset.level === currentLevel){ b.classList.add('bg-indigo-500','text-white'); }
    });
    document.querySelectorAll('.mode-btn').forEach(b=>{
      b.classList.remove('bg-indigo-500','text-white');
      if(b.dataset.mode === currentMode){ b.classList.add('bg-indigo-500','text-white'); }
    });
  }
  setInitialButtons();

  // ======= UI Wire‑up =======
  document.querySelectorAll('.difficulty-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      currentLevel = btn.dataset.level;
      document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('bg-indigo-500','text-white'));
      btn.classList.add('bg-indigo-500','text-white');
      addBotMessage(`Switched to ${currentLevel} mode. I will adjust explanations, steps, and vocabulary accordingly.`, {badge:`${capitalize(currentLevel)}`});
    });
  });

  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      currentMode = btn.dataset.mode;
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('bg-indigo-500','text-white'));
      btn.classList.add('bg-indigo-500','text-white');
      const quizOn = currentMode === 'quiz';
      toolbarChat.classList.toggle('hidden', quizOn);
      toolbarQuiz.classList.toggle('hidden', !quizOn);
      addBotMessage(`Switched to ${quizOn ? 'Quiz' : 'Chat'} mode.`, {badge: quizOn ? 'Quiz' : 'Chat'});
    });
  });

  sendBtn.addEventListener('click', onSend);
  input.addEventListener('keydown', (e) => { if (e.key === 'Enter') onSend(); });
  clearBtn.addEventListener('click', clearChat);

  quizGenerate.addEventListener('click', () => generateQuiz(quizTopic.value.trim(), parseInt(quizCount.value || '5', 10)));
  quizClear.addEventListener('click', clearChat);

  function clearChat(){
    chat.innerHTML = `
      <div class="flex items-start gap-2">
        <div class="bg-indigo-100 p-3 rounded-full"><i data-feather="cpu" class="text-indigo-500"></i></div>
        <div class="bg-gray-100 rounded-lg p-3 msg">
          <p class="text-gray-800">Chat cleared. Ask me anything!</p>
        </div>
      </div>`;
    feather.replace();
  }

  function onSend(){
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    addUserMessage(text);
    addThinking();
    askLLM(buildChatPrompt(text)).then(reply => {
      removeThinking();
      addBotMessage(formatLLMText(reply), {actions:[{name:'Make it simpler', handler: () => reExplain(reply, 'simpler')}, {name:'One level harder', handler: () => reExplain(reply, 'harder')}], badge: capitalize(currentLevel)});
    }).catch(err => {
      removeThinking();
      addBotMessage("Sorry, I couldn't generate a response.");
      console.error(err);
    });
  }

  function reExplain(previous, mode){
    addThinking();
    const directive = mode === 'simpler' ? 'Re-explain in simpler, shorter terms with a concrete analogy and keep critical steps.' : 'Re-explain at a more advanced level: terser prose, focus on formalism, assumptions, and edge cases.';
    askLLM([{text: directive},{text: `Original explanation to rewrite:\n\n${previous}`}]).then(reply => {
      removeThinking();
      addBotMessage(formatLLMText(reply), {badge: mode === 'simpler' ? 'Simplified' : 'Advanced'});
    }).catch(err => { removeThinking(); addBotMessage('Had trouble re-explaining.'); console.error(err); });
  }

  // ======= LLM plumbing (Gemini) =======
  const GEMINI_MODEL = 'gemini-2.0-flash';
  // Provide your key via a safer mechanism (env/secret). Fallback reads from a global var if you set it before this script: window.GEMINI_KEY = '...';
  const GEMINI_KEY = (window.GEMINI_KEY || 'AIzaSyD7eJyw66zU42y0zhI6OxuSaORR4yXtEh8').trim();

  async function askLLM(contentParts){
    // contentParts can be string or array of {text}
    const parts = Array.isArray(contentParts) ? contentParts : [{text: contentParts}];

    if(!GEMINI_KEY){
      return 'LLM is not configured. Please set GEMINI_KEY.';
    }

    try{
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${encodeURIComponent(GEMINI_KEY)}` ,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ contents:[{ parts }] , generationConfig:{ temperature:0.2, maxOutputTokens: 1024 }})
      });

      if(!res.ok){
        const text = await res.text();
        throw new Error(`Gemini error ${res.status}: ${text}`);
      }

      const data = await res.json();
      const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || JSON.stringify(data);
      return reply;
    }catch(err){
      console.error(err);
      return 'There was a problem contacting Gemini (network or key). Please verify your API key and network, then try again.';
    }
  }

  function buildChatPrompt(userQuestion){
    return `You are EduGenie, a helpful tutor for math and data science. Always return a clear step-by-step solution tailored to the difficulty level.\n\nCurrent difficulty: ${currentLevel}.\nGuidelines by level:\n- Beginner: Use plain language, define symbols, small logical steps, relatable analogies.\n- Intermediate: Use standard terminology, show derivations with moderate rigor, highlight key formulas and why they work.\n- Advanced: Be concise and formal, include assumptions, edge cases, complexity/conditions, and optional proofs.\n\nFormatting:\n1) Give "Solution (Step-by-step)" with numbered steps.\n2) Then a short "Key idea" line.\n3) If there are formulas, put them inline with simple ASCII where needed.\n\nQuestion: ${userQuestion}`;
  }

  // ======= Quiz generator + auto-check =======
  async function generateQuiz(topic, count){
    if(!topic){ addBotMessage('Please enter a quiz topic.'); return; }
    addUserMessage(`Generate a ${count}-question quiz on: ${topic}`);
    addThinking();
    const prompt = `Create a ${count}-question quiz on the topic \"${topic}\" at ${currentLevel} level for math/data science learners. Respond with ONLY a JSON object with the single key \"questions\" (no prose, no backticks). Each item must be: {\n  \"q\": string,\n  \"type\": \"numeric\" | \"text\",\n  \"answer\": string | number,\n  \"explain\": string,\n  \"tolerance\": optional number\n}`;
    try{
      const raw = await askLLM(prompt);
      window.__lastQuizRaw = String(raw);
      const parsed = safeParseQuizJSON(raw);
      removeThinking();
      if(!parsed?.questions?.length){ addBotMessage('I could not create the quiz. Try another topic.'); return; }
      renderQuiz(parsed.questions);
    }catch(e){
      removeThinking();
      addBotMessage('The quiz format was invalid. Please try again.');
      console.error(e);
    }
  }

  function renderQuiz(questions){
    const wrap = document.createElement('div');
    wrap.className = 'bg-white border rounded-lg p-3 space-y-3';

    questions.forEach((q, idx) => {
      const id = `q-${Date.now()}-${idx}`;
      const row = document.createElement('div');
      row.className = 'border rounded-lg p-3';
      row.innerHTML = `
        <div class=\"flex items-start gap-2\">
          <div class=\"bg-indigo-100 p-2 rounded-full\"><i data-feather=\"help-circle\" class=\"text-indigo-500\"></i></div>
          <div class=\"flex-1\">
            <div class=\"flex items-center justify-between gap-2\">
              <p class=\"font-medium\">Q${idx+1}. ${escapeHTML(q.q || '')}</p>
              <span class=\"badge px-2 py-1 rounded-full bg-gray-100 text-gray-600\">${q.type || 'text'}</span>
            </div>
            <div class=\"mt-2 flex items-center gap-2\">
              <input id=\"${id}-input\" class=\"flex-1 border rounded-full px-3 py-2\" placeholder=\"Your answer\" />
              <button id=\"${id}-check\" class=\"bg-emerald-500 text-white rounded-full px-3 py-2 btn\">Check</button>
            </div>
            <div id=\"${id}-result\" class=\"mt-2 text-sm\"></div>
          </div>
        </div>`;

      wrap.appendChild(row);

      setTimeout(()=>{
        const btn = document.getElementById(`${id}-check`);
        btn?.addEventListener('click', () => {
          const userAns = document.getElementById(`${id}-input`).value.trim();
          const res = document.getElementById(`${id}-result`);
          const correct = checkAnswer(userAns, q);
          res.innerHTML = correct
            ? `<span class='text-emerald-700 font-semibold'>Correct!</span> <button class=\"ml-2 text-indigo-600 underline\" onclick=\"this.nextElementSibling.classList.toggle('hidden')\">Why?</button><span class=\"hidden ml-1\">${escapeHTML(q.explain || '')}</span>`
            : `<span class='text-rose-700 font-semibold'>Not quite.</span> <button class=\"ml-2 text-indigo-600 underline\" onclick=\"this.nextElementSibling.classList.toggle('hidden')\">Show solution</button><span class=\"hidden ml-1\">Ans: ${escapeHTML(String(q.answer))}. ${escapeHTML(q.explain || '')}</span>`;
        });
      }, 0);
    });

    // Add a collapsible with raw model output if lastRaw exists
    if(window.__lastQuizRaw){
      const details = document.createElement('details');
      details.className = 'mt-2';
      details.innerHTML = `<summary class='text-xs text-gray-500'>Debug: show raw model output</summary><pre class='text-xs whitespace-pre-wrap p-2 bg-gray-50 border rounded'>${escapeHTML(window.__lastQuizRaw)}</pre>`;
      wrap.appendChild(details);
    }

    addCustomBlock(wrap, {badge:'Quiz'});
    feather.replace();
  }

  function checkAnswer(user, q){
    if((q.type||'text') === 'numeric'){
      const u = Number(user.replace(/\s/g,''));
      const a = Number(q.answer);
      if(isNaN(u) || isNaN(a)) return false;
      const tol = typeof q.tolerance === 'number' ? Math.abs(q.tolerance) : 1e-6;
      return Math.abs(u - a) <= tol + 1e-12 * Math.max(1, Math.abs(a));
    }
    // text: case-insensitive, trim, basic keyword match fallbacks
    const u = user.toLowerCase();
    const a = String(q.answer || '').toLowerCase();
    if(!a) return false;
    if(u === a) return true;
    // keyword intersection
    const keyA = a.split(/[^a-z0-9]+/).filter(Boolean);
    const keyU = u.split(/[^a-z0-9]+/).filter(Boolean);
    const setA = new Set(keyA);
    const hit = keyU.filter(t => setA.has(t)).length;
    return hit >= Math.max(1, Math.ceil(keyA.length * 0.4));
  }

  // ======= DOM helpers =======
  function addUserMessage(msg){
    const div = document.createElement('div');
    div.className = 'flex items-start justify-end';
    div.innerHTML = `<div class="bg-indigo-500 text-white p-3 rounded-lg max-w-xl msg"><p>${escapeHTML(msg)}</p></div>`;
    chat.appendChild(div); chat.scrollTop = chat.scrollHeight;
  }

  function addThinking(){
    const div = document.createElement('div');
    div.id = 'thinking';
    div.className = 'flex items-start gap-2';
    div.innerHTML = `<div class=\"bg-indigo-100 p-3 rounded-full\"><i data-feather=\"cpu\" class=\"text-indigo-500\"></i></div><div class=\"bg-gray-100 rounded-lg p-3 msg\"><p>Thinking…</p></div>`;
    chat.appendChild(div); chat.scrollTop = chat.scrollHeight; feather.replace();
  }
  function removeThinking(){ const t = document.getElementById('thinking'); if(t) chat.removeChild(t); }

  function addBotMessage(msg, opts={}){
    const div = document.createElement('div');
    div.className = 'flex items-start gap-2';
    const badge = opts.badge ? `<span class='ml-2 text-xs px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 align-middle'>${escapeHTML(opts.badge)}</span>` : '';
    div.innerHTML = `
      <div class="bg-indigo-100 p-3 rounded-full"><i data-feather="cpu" class="text-indigo-500"></i></div>
      <div class="bg-gray-100 rounded-lg p-3 msg max-w-xl">
        <div class="flex items-center justify-between mb-1">
          <div class="text-gray-700 text-xs">EduGenie ${badge}</div>
          <div class="space-x-1">
            ${(opts.actions||[]).map((a,i)=>`<button class=\"text-indigo-600 underline text-xs\" data-action-idx=\"${i}\">${escapeHTML(a.name)}</button>`).join('')}
          </div>
        </div>
        <p>${msg}</p>
      </div>`;
    chat.appendChild(div); chat.scrollTop = chat.scrollHeight; feather.replace();
    // wire actions
    const buttons = div.querySelectorAll('[data-action-idx]');
    buttons.forEach(b => b.addEventListener('click', () => {
      const idx = Number(b.getAttribute('data-action-idx'));
      const action = opts.actions[idx];
      if(action?.handler) action.handler();
    }));
  }

  function addCustomBlock(node, opts={}){
    const div = document.createElement('div');
    div.className = 'flex items-start gap-2';
    const badge = opts.badge ? `<span class='ml-2 text-xs px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 align-middle'>${escapeHTML(opts.badge)}</span>` : '';
    div.innerHTML = `<div class=\"bg-indigo-100 p-3 rounded-full\"><i data-feather=\"cpu\" class=\"text-indigo-500\"></i></div>`;
    const wrap = document.createElement('div');
    wrap.className = 'bg-gray-100 rounded-lg p-3 msg w-full';
    wrap.innerHTML = `<div class=\"flex items-center justify-between mb-2\"><div class=\"text-gray-700 text-xs\">EduGenie ${badge}</div></div>`;
    wrap.appendChild(node);
    div.appendChild(wrap);
    chat.appendChild(div); chat.scrollTop = chat.scrollHeight; feather.replace();
  }

  function formatLLMText(t){
    // Basic formatting: convert Markdown-ish to simple text, but keep it safe.
    return escapeHTML(t)
      .replace(/\*\*(.*?)\*\*/g, '$1')
      .replace(/\*(.*?)\*/g, '$1')
      .replace(/`{1,3}([^`]+)`{1,3}/g, '$1');
  }

  function escapeHTML(s){
    return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[c]));
  }
  function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

  // Robust JSON pre-processing for quiz output
  function safeParseQuizJSON(raw){
    let s = String(raw).trim();
    // strip code fences/backticks
    s = s.replace(/^```(?:json)?\s*/i, '').replace(/```\s*$/i, '').trim();
    // drop any leading chatter before first { or [
    const iObj = s.indexOf('{');
    const iArr = s.indexOf('[');
    let i = -1;
    if(iObj >= 0 && iArr >= 0) { i = Math.min(iObj, iArr); } else { i = iObj >= 0 ? iObj : iArr; }
    if(i > 0) s = s.slice(i);

    // Try parse as-is
    try {
      const parsed = JSON.parse(s);
      if(Array.isArray(parsed)) return { questions: parsed };
      return parsed;
    } catch(e) {}

    // Try to capture an object {...}
    const objMatch = s.match(/\{[\s\S]*\}/);
    if(objMatch){
      try {
        return JSON.parse(objMatch[0]);
      } catch(e) {}
    }

    // Try to capture an array [...] and wrap
    const arrMatch = s.match(/\[[\s\S]*\]/);
    if(arrMatch){
      try {
        const arr = JSON.parse(arrMatch[0]);
        return { questions: arr };
      } catch(e) {}
    }

    throw new Error('Invalid JSON');
  }

  // Background visual (guarded)
  try{
    VANTA.GLOBE({
      el: "#vanta-bg",
      mouseControls: true,
      touchControls: true,
      minHeight: 200.00,
      minWidth: 200.00,
      scale: 1.00,
      scaleMobile: 1.00,
      color: "#6366f1",
      backgroundColor: "#f9fafb",
      size: 0.8
    });
  }catch(e){
    console.warn('[VANTA] init failed, falling back to solid bg', e);
  }
</script>
</body>
</html>
